name: Bump version
on:
  workflow_dispatch:
    inputs:
      bump-type:
        description: 'The bump type for new release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - version
      version:
        type: string
        description:
          'Explicit version to bump to, if `bump-type` is set to `version`'

jobs:
  bump-version:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      # renovate: datasource=github-releases depName=python-poetry/poetry
      POETRY_VERSION: '2.2.1'
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install poetry
        run: pip3 install "poetry==${{ env.POETRY_VERSION }}"

      - name: Setup python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
        with:
          python-version-file: '.python-version'
          cache: 'poetry'

      - name: Setup PNPM
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          package_json_file: frontend/package.json

      - name: Set up Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          cache-dependency-path: "frontend/pnpm-lock.yaml"

      - name: Install rust toolchain
        run: cargo version

      - name: Cache rust artifacts
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: tests
          save-if: false

      - name: Bump packages to new version number
        env:
          BUMP_TYPE: ${{ inputs.bump-type }}
          VERSION: ${{ inputs.version }}
        run: ./scripts/bump_version.sh "$BUMP_TYPE" "$VERSION"

      - name: Create pull request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          commit-message: 'release: ${{ env.NEXT_VERSION }}'
          title: 'release: ${{ env.NEXT_VERSION }}'
          body: 'Bump radiojournal packages to version ${{ env.NEXT_VERSION }}'
          branch: release-${{ env.NEXT_VERSION }}
          reviewers: |
            fluxth
